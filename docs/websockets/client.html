<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
	<title>WebSocket Example</title>
</head>
<body>
	<h1>WebSocket Example</h1>
    <button type="button" class="btn btn-light" id="startButton">Start Websocket</button>
	<input class="form-control" type="text" placeholder="Username" id="username" value="SaladLover42">
	<br>
	<textarea id="display" readonly></textarea>
	<br>
	<input class="form-control" type="text" placeholder="Say HALLO!" id="textMessage">
	<button type="button" class="btn btn-dark" id="message">Send</button>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
		
		let socket;
		var myGamePiece;

		function startGame() {
			myGameArea.start();
			myGamePiece = new component(30, 30, "red", 10, 120);
		}

		var myGameArea = {
			canvas : document.createElement("canvas"),
			start : function() {
				this.canvas.width = 480;
				this.canvas.height = 270;
				this.key = 0;
				this.context = this.canvas.getContext("2d");
				document.body.insertBefore(this.canvas, document.body.childNodes[0]);
				this.interval = setInterval(updateGameArea, 20);
				window.addEventListener('keydown', function (e) {
					myGameArea.key = e.keyCode;
					console.log("aaaaaaaaaaaaaaaaaaaaaa");
				}),
				window.addEventListener('keyup', function (e) {
					myGameArea.key = 0;
				})
			},
			clear : function() {
				this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
			},
		}
		
		function component(width, height, color, x, y) {
			this.width = width;
			this.height = height;
			this.x = x;
			this.y = y;
			this.speedX = 0;
			this.speedY = 0;
			ctx = myGameArea.context;
			ctx.fillStyle = color;
			ctx.fillRect(this.x, this.y, this.width, this.height);
			this.update = function(){
				ctx = myGameArea.context;
				ctx.fillStyle = color;
				this.speedX = 0;
				this.speedY = 0;
				if (myGameArea.key != 0) {this.speedX = 1;}
				this.x += this.speedX;
				ctx.fillRect(this.x, this.y, this.width, this.height);
				
				if (this.speedX != 0 && socket && socket.readyState === WebSocket.OPEN)
				{
					const jsonMessage = {
						type: "game",
						user: username,
						x: this.x,
						y: this.y,
						time: new Date().toISOString()
					};
	
					jsonString = JSON.stringify(jsonMessage);
					socket.send(jsonString);
				}
			}
		}
		
		function updateGameArea() {
			myGameArea.clear();
			myGamePiece.update();
		}
		function displayData(data)
		{
			const displayElement = document.getElementById('display');
			
			displayElement.value += `${data.user}: ${data.data} (${data.timestamp})\n`;
		}
        // Function to start WebSocket connection
		function startWebSocket() {
			startGame();
			// Create WebSocket connection
			socket = new WebSocket("ws://localhost:8001");

			// when the connection is open
			socket.onopen = function(e)
			{
				console.log("[open] Connection established");
			};
			
			// receive messages from the server
			socket.onmessage = function(event)
			{
				const data = JSON.parse(event.data)

				if (data.type == "message")
					displayData(data);
				else
				{
					myGamePiece.x = data.x;
					myGamePiece.y = data.y;
				}

				// console.log(`[message] Data received from server: ${event.data}`);
			};
			
			// close the connection
			socket.onclose = function(event)
			{
				if (event.wasClean)
				console.log(`[close] Connection closed cleanly, code=${event.code}, reason=${event.reason}`);
			else
			console.log('[close] Connection died');
	};

			// in case of an error
			socket.onerror = function(error)
			{
				console.error(`[error] ${error.message}`);
			};
		}

		function sendMessage(){
			let message = document.getElementById("textMessage").value;
			let username = document.getElementById("username").value;
			
			// if websockets exists and is opened
			if (socket && socket.readyState === WebSocket.OPEN)
			{
				// Create a JSON object
				const jsonMessage = {
					type: "message",
					user: username,
					data: message,
					timestamp: new Date().toISOString()
				};
				
				// Convert the JSON object to a string
				const jsonString = JSON.stringify(jsonMessage);
	
				// Send the JSON string over the WebSocket connection
				socket.send(jsonString);
				
				// clear input
				document.getElementById("textMessage").value = "";
			}
		}

        // start WebSocket connection when button is clicked
        document.getElementById("startButton").addEventListener("click", startWebSocket);
		document.getElementById("message").addEventListener("click", sendMessage);
    </script>
</body>
</html>